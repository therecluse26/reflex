name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to publish'
        required: true

permissions:
  contents: write
  id-token: write  # Required for crates.io Trusted Publishing

jobs:
  publish-crates-io:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Authenticate with crates.io (Trusted Publishing)
        uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Publish to crates.io
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

  publish-winget:
    name: Publish to WinGet
    runs-on: ubuntu-latest
    steps:
      - name: Publish to WinGet
        uses: vedantmgoyal9/winget-releaser@v2
        with:
          identifier: reflex-search.reflex
          token: ${{ secrets.WINGET_TOKEN }}
          # This will auto-create a PR to microsoft/winget-pkgs

  update-scoop:
    name: Update Scoop Bucket
    runs-on: ubuntu-latest
    steps:
      - name: Update Scoop manifest
        uses: Ash258/Scoop-GithubActions@stable
        env:
          GITHUB_TOKEN: ${{ secrets.SCOOP_TOKEN }}
          GITH_EMAIL: github-actions[bot]@users.noreply.github.com
        with:
          app_name: reflex

  update-homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew formula
        uses: dawidd6/action-homebrew-bump-formula@v3
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          formula: reflex
          tap: reflex-search/homebrew-tap
          tag: ${{ github.event.release.tag_name || github.event.inputs.tag }}

  update-aur:
    name: Update AUR Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate PKGBUILD
        run: |
          VERSION="${{ github.event.release.tag_name || github.event.inputs.tag }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix

          # Update version in PKGBUILD
          sed -i "s/pkgver=.*/pkgver=${VERSION}/" aur/PKGBUILD

          # Calculate checksums for all architectures
          cd aur
          makepkg --verifysource --skipchecksums
          updpkgsums
          makepkg --printsrcinfo > .SRCINFO

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
        with:
          pkgname: reflex-bin
          pkgbuild: aur/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to version ${{ github.event.release.tag_name || github.event.inputs.tag }}"
